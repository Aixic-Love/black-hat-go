## 摘要

在前面的章节中，已经验证了包括原生TCP，HTTP 和 DNS 这几种常用的网络通信协议。对于攻击者来说，这些协议都有有趣的用例。尽管存在大量其他网络协议，但我们将通过检查 Server Message Block(SMB)来结束对网络协议的讨论，这个协议被证明是Windows后开发中最有用的协议。

SMB 可能是本书中最复杂的协议。它有多种用途，但是 SMB 通常用于分享资源，像文件，打印机和网络串口。对于有攻击想法的读者，SMB允许分布式网络节点通过命名管道进行进程间通信。换言之，可以在远程主机上执行任意的命令。这基本上就是PsExec的工作原理，PsExec是一个在本地执行远程命令的Windows工具。

SMB还有其他几个有趣的用例，特别是由于它处理NT LAN Manager (NTLM)身份验证的方式，这是Windows网络上大量使用的质问-响应安全协议。用于包括远程密码猜测，基于hash认证（或哈希加密），SMB中继和NBNS/LLMNR欺骗。完全讲解这些攻击需要用整本书的篇幅。

在本章的开头，将详细讲解如何在Go中实现SMB。然后，运用SMB包执行远程密码猜测，使用“哈希加密”技术，通过只使用密码的哈希，并破解密码的NTLMv2哈希，从而成功地验证自己的身份。

## SMB 包

写这本书时，还没有官方发布的Go版本的 SMB 包，但是可以在 ** https://github.com/bhg/ch-6/smb/ ** 上找和本书中配套的相应版本。尽管在本章中不会展开该包的所有细节，但为了创建“说SMB”所必需的二进制通信，扔要学习执行SMB规范的基础知识，不像前面的章节那样，只是简单地重复使用完全兼容的软件包。在这将学习如何使用反射，在运行时检查接口数据类型和定义任意Go结构体中的字段标签来解编码复杂的，任意的数据，同时维护未来的消息结构和数据类型可伸缩性。

虽然我们构建的SMB库只允许基本的客户端通信，但代码库相当广泛。会有SMB包相关的例子，以便能完全理解像SMB认证这样的通信和任务是如何工作的。

